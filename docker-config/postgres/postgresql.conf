# PostgreSQL configuration file for PetPro application
# Optimized for performance and security

# Connection settings
listen_addresses = '*'
max_connections = 200
superuser_reserved_connections = 5

# Memory settings
shared_buffers = 512MB                # 25% of available RAM (assuming 2GB container)
effective_cache_size = 1536MB         # 75% of available RAM
work_mem = 16MB                       # Per-operation memory
maintenance_work_mem = 128MB          # For maintenance operations
dynamic_shared_memory_type = posix    # Recommended for Linux/macOS containers

# Write-Ahead Log (WAL)
wal_level = replica                   # Enables WAL archiving for backup
max_wal_size = 4GB
min_wal_size = 1GB
wal_buffers = 16MB                    # 1/32 of shared_buffers, rounded up
checkpoint_completion_target = 0.9    # Spread checkpoints for less I/O spikes

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Query planner
random_page_cost = 4.0                # Assuming decent SSD storage
effective_io_concurrency = 2          # For SSDs
default_statistics_target = 100       # Increase for complex queries

# Logging
log_destination = 'stderr'
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000     # Log slow queries (1s)
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0                    # Log all temp file usage
log_timezone = 'UTC'

# Statement behavior
search_path = '"$user", public'
statement_timeout = 60000             # 60 seconds
lock_timeout = 10000                  # 10 seconds
idle_in_transaction_session_timeout = 600000  # 10 minutes

# Security
ssl = off                            # Configured at Docker level
row_security = on
password_encryption = 'scram-sha-256' # Strong password hashing

# Autovacuum settings
autovacuum = on
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 20ms   # Less aggressive for better response time

# Client connection defaults
client_min_messages = notice
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# Compatibility options
standard_conforming_strings = on
escape_string_warning = on
